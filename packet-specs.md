# Спецификация пакетов

- Каждый пакет представлен в виде строки набора чисел, разделённых пробелом. Конец пакета помечается символом перевода строки (`\n`).

- Все числа передаются в строковом формате.

- Все аргументы передаются в том порядке, в каком они указаны в спецификации.

- Шаблон пакета:
  `<status> [<arg1> <arg2>...]`

Само содержимое пакетов будет указано ниже (см. "Ответы от сервера" и "Запросы от клиента").

## Игровой процесс

Игра считается пошаговой, но всем игрокам одновременно даётся время на ход в 5500 миллисекунд. По истечении этого времени начинается новый ход (см. NewTurn и NewTurnSpectator), а старый ID хода сгорает. Если игрок не сделал ход в течение этого времени, то он остаётся на прежнем месте.

## Формат игровой карты

Существует соглашение о размерах карты и позиции выхода на ней.

Размер карты всегда 31x31, выход находится на позиции `(floor(W/2), floor(W/2))`, в данном случае это `(15, 15)`.

### Система координат

Используется целочисленная система координат. Нулевая точка координат находится в левом верхнем углу карты. Ось ординат направлена вниз, ось абсцисс направлена вправо. Так, правая нижняя точка карты будет иметь координаты `(W-1, H-1)`, где `W`, `H` -- ширина и высота карты.

### Объекты на карте

На карте могут быть следующие объекты:

* 0: пол;
* 1: стена;
* 2: выход;
* 3, 4, 5, 6: игрок 1, 2, 3, 4 соответственно;
* Числа в отрезке [7; 18] -- несколько игроков в одной точке.

### Положение игроков на карте

Исходя из предыдущего пункта (см. "Объекты на карте"), можно сделать вывод, что несколько игроков на одной клетке представлены в виде суммы ID объектов. Например, ID 7 означает, что в клетке находятся одновременно игроки 1 и 2 (сумма ID -- 3 + 4). Так как каждый игрок знает свой ID на карте, нетрудно вычислить, кто именно находится в клетке.

Для упрощения задачи на каждый ход передаются координаты игроков в радиусе видимости.

Стоит отметить, что игра может начаться с тремя, двумя и даже с одним игроком. В таком случае на карте будут отсутствовать ID `[6]`; `[6, 5]` или `[6; 5; 4]` соответственно.

### Частичная передача карты

Когда игрок ходит, он не видит карту целиком, лишь её часть в пределах радиуса видимости. Поэтому существует договорённость, что радиус видимости игрока -- 1, боковые клетки не учитываются.

Таким образом, на каждом ходу игрок получает часть карты в следующем порядке:

1. Клетка слева от игрока
2. Клетка справа
3. Клетка снизу
4. Клетка сверху
5. Клетка посередине

Клетка посередине не может быть равна 0, так как на ней всегда находится игрок. К ней применяются те же правила, что и для остальных клеток (см. "Объекты на карте" и "Положение игроков на карте").

## Запросы от клиента

При подключении к серверу клиент получает от сервера ServerConnected. С этого момента можно отправлять запросы.

### CreateLobby

Запрос на создание игровой комнаты (лобби).

Можно отослать только после полученного пакета ServerConnected.

**Статус:** 110

**Аргументы:** *нет*

**Ответы**:

- LobbyCreated
- UnknownError

### JoinLobby

Запрос на подключение к лобби.

Можно отослать только после полученного пакета ServerConnected.

**Статус:** 105

**Аргументы:**

- *sessionId*: ID лобби, к которому надо присоединиться.

**Ответы**:

- PlayerReady (в случае успеха)
- LobbyNotExist
- LobbyFull
- UnknownError

### NotifyReady

Уведомление о готовности игрока.

Можно отослать только в лобби (после получения пакета PlayerReady) и только если игрок не уведомлял о своей готовности начать игру.

**Статус:** 112

**Аргументы:** *нет*

**Ответы**:

- PlayerReady
- GameStart (если все игроки готовы, на последующие ходы будут присылаться NewTurn)
- UnknownError

### LeaveLobby

Запрос на выход лобби.

Можно отослать только в лобби или по завершении игры (после получения пакета PlayerReady или GameOver). В случае спектаторов можно также выйти во время игры (после получения пакетов GameStartSpectator, NewTurnSpectator и GameOver)

**Статус:** 106

**Аргументы:** *нет*

**Ответы**:

- ServerConnected
- UnknownError

### MoveLeft, MoveRight, MoveDown, MoveUp

Запрос на ход в указанную сторону. Направление зависит от статуса.

Можно отослать только во время игры (после получения пакета GameStart, NewTurn или WrongTurnId)

**Статус:** зависит от направления:

- *202*: влево
- *203*: вправо
- *204*: вниз
- *205*: вверх

**Аргументы:**

- *turnId*: ID хода, полученный пакетом ранее

**Ответы**:

- NewTurn
- WrongTurnId (в случае некорректного *turnId*)
- GameOver
- UnknownError

### JoinLobbySpectator

Запрос на подключение к лобби в качестве зрителя (спектатора).

Можно отослать только после полученного пакета ServerConnected.

**Статус:** 305

**Аргументы:**

- *sessionId*: ID лобби, к которому надо присоединиться.

**Ответы**:

- GameStartSpectator (в случае успеха, в дальнейшем будут присылаться пакеты NewTurnSpectator)
- LobbyNotExist
- GameNotYetStarted
- UnknownError

## Ответы от сервера

### ServerConnected

Оповещает об успешном подключении к серверу.

Важно отметить, что этот же код возвращается при успешном выходе из лобби.

**Статус:** 500

**Аргументы:** *нет*

### UnknownError

Сообщает о неизвестной ошибке. Как правило, возникает при передаче некорректных данных (например, попытка создать лобби во время активной игры) или ошибке на стороне сервера, которую нельзя корректно обработать на клиенте.

**Статус:** 666

**Аргументы:** *нет*

### LobbyCreated

Уведомляет об успешно созданной игровой комнате. Возвращает идентификатор созданной комнаты.

**Статус:** 505

**Аргументы:**

- *sessionId*: ID созданного лобби.

### LobbyNotExist

Сообщает о том, что лобби не существует. Возможные причины:

- Лобби с таким ID действительно не существует
- Игра уже началась, либо закончилась

**Статус:** 506

**Аргументы:** *нет*

### LobbyFull

Сообщает о том, что лобби полностью заполнено, и свободных слотов для подключения нет.

**Статус:** 507

**Аргументы:** *нет*

### PlayerLeft

Уведомляет о том, что один из игроков покинул лобби. При получении данного пакета у всех игроков сбрасывается статус готовности к игре (у всех ставится статус "Не готов").

**Статус:** 508

**Аргументы:**

- *playersTotal*: Общее число игроков в лобби.

### PlayerReady

Уведомляет о том, что один из игроков в лобби сменил статус готовности на "Готов".

**Статус:** 509

**Аргументы:**

- *playersReady*: Число готовых игроков в лобби.
- *playersTotal*: Общее число игроков в лобби.

### GameStart

Уведомляет о том, что игра началась. Сервер передаёт начальные данные.

При отсылке запроса на ход нужно учесть, что на этом моменте ID хода равен 0.

См. "Формат игровой карты".

**Статус:** 510

**Аргументы:**

- *playerColor*: Цвет текущего игрока (в отрезке `[3; 6]`).
- *mapSizeWidth*: Ширина карты.
- *mapSizeHeight*: Высота карты.
- *playerPosX*: Координата `x` текущего игрока.
- *playerPosY*: Координата `y` текущего игрока.
- *visibleCells*: Видимые игроку клетки (см. "Частичная передача карты" за подробностями)

### NewTurn

Уведомляет о новом ходе в игре.

См. "Формат игровой карты".

**Статус:** 777

**Аргументы:**

- *turnId*: ID нового хода (должен быть использован при передаче запроса на ход).
- *playerPosX*: Координата `x` текущего игрока.
- *playerPosY*: Координата `y` текущего игрока.
- *visibleCells*: Видимые игроку клетки (см. "Частичная передача карты" за подробностями)
- *rivals*: Позиции противников в следующем формате:
  - *color*: Цвет игрока в отрезке `[3; 6]` (см. "Объекты на карте")
  - *posX*: Координата `x` игрока
  - *posY*: Координата `y` игрока

Если противника не видно, то его координаты будут `(0, 0)`.

### WrongTurnId

Уведомляет о том, что игрок при попытке походить передал неправильный ID хода. Как правило, такое может произойти, если он "отстал" от игры и пытается сделать ход со старым ID.

**Статус:** 700

**Аргументы:**

- *turnId*: Актуальный ID хода на момент отсылки ответа сервером.

### GameOver

Сообщает о том, что игра окончена.

**Статус:** 555

**Аргументы:**

- *playersWon*: победившие игроки в следующем формате:
  - *sessionId*: ID игрока на сервере (не используется)
  - *color*: цвет игрока в отрезке `[3; 6]` (см. "Объекты на карте")

Обратите внимание, что количество победителей не указывается, его можно узнать, исходя из того, сколько пар чисел будет в аргументах.

**Пример:**

Для трёх победителей:
`700 3 3 8 5 2 6`

Для одного победителя:
`700 3 3`

### GameNotYetStarted

Сообщает о том, что лобби существует, но игра ещё не началась. Применимо только для запроса JoinLobbySpectator.

**Статус:** 511

**Аргументы:** *нет*

### GameStartSpectator

Сообщает о том, что зритель (спектатор) успешно подключился к игре. Применимо только для запроса JoinLobbySpectator.

**Статус:** 513

**Аргументы:**
- *width*: ширина карты
- *height*: высота карты
- *map*: `W`x`H` чисел с ID объектов на карте (см. "Формат игровой карты").
- *playersPos*: позиции игроков в следующем формате:
  - *color*: цвет игрока в отрезке `[3; 6]` (см. "Объекты на карте")
  - *posX*: Координата `x` игрока
  - *posY*: Координата `y` игрока

### NewTurnSpectator

Сообщает спектатору о том, что начался новый ход. Применимо только для запроса JoinLobbySpectator.

**Статус:** 770

**Аргументы:**
- *turn*: номер хода в текущей игре
- *playersPos*: позиции игроков в следующем формате:
  - *color*: цвет игрока в отрезке `[3; 6]` (см. "Объекты на карте")
  - *posX*: Координата `x` игрока
  - *posY*: Координата `y` игрока